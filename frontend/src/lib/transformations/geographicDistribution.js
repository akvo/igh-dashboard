/**
 * Geographic Distribution transformation functions
 * Transforms raw API response into map-ready format
 */

/**
 * ISO 3166-1 alpha-3 to numeric code mapping.
 * The DB returns alpha-3 codes (e.g. "USA") but the world-atlas TopoJSON
 * uses numeric IDs (e.g. 840). This lookup bridges the two.
 */
const ALPHA3_TO_NUMERIC = {
  AFG: '004', ALB: '008', DZA: '012', ASM: '016', AND: '020',
  AGO: '024', ATG: '028', ARG: '032', ARM: '051', ABW: '533',
  AUS: '036', AUT: '040', AZE: '031', BHS: '044', BHR: '048',
  BGD: '050', BRB: '052', BLR: '112', BEL: '056', BLZ: '084',
  BEN: '204', BMU: '060', BTN: '064', BOL: '068', BIH: '070',
  BWA: '072', BRA: '076', BRN: '096', BGR: '100', BFA: '854',
  BDI: '108', CPV: '132', KHM: '116', CMR: '120', CAN: '124',
  CAF: '140', TCD: '148', CHL: '152', CHN: '156', COL: '170',
  COM: '174', COG: '178', COD: '180', CRI: '188', CIV: '384',
  HRV: '191', CUB: '192', CUW: '531', CYP: '196', CZE: '203',
  DNK: '208', DJI: '262', DMA: '212', DOM: '214', ECU: '218',
  EGY: '818', SLV: '222', GNQ: '226', ERI: '232', EST: '233',
  SWZ: '748', ETH: '231', FJI: '242', FIN: '246', FRA: '250',
  GAB: '266', GMB: '270', GEO: '268', DEU: '276', GHA: '288',
  GRC: '300', GRD: '308', GTM: '320', GIN: '324', GNB: '624',
  GUY: '328', HTI: '332', HND: '340', HUN: '348', ISL: '352',
  IND: '356', IDN: '360', IRN: '364', IRQ: '368', IRL: '372',
  ISR: '376', ITA: '380', JAM: '388', JPN: '392', JOR: '400',
  KAZ: '398', KEN: '404', KIR: '296', PRK: '408', KOR: '410',
  KWT: '414', KGZ: '417', LAO: '418', LVA: '428', LBN: '422',
  LSO: '426', LBR: '430', LBY: '434', LIE: '438', LTU: '440',
  LUX: '442', MDG: '450', MWI: '454', MYS: '458', MDV: '462',
  MLI: '466', MLT: '470', MHL: '584', MRT: '478', MUS: '480',
  MEX: '484', FSM: '583', MDA: '498', MCO: '492', MNG: '496',
  MNE: '499', MAR: '504', MOZ: '508', MMR: '104', NAM: '516',
  NRU: '520', NPL: '524', NLD: '528', NZL: '554', NIC: '558',
  NER: '562', NGA: '566', MKD: '807', NOR: '578', OMN: '512',
  PAK: '586', PLW: '585', PAN: '591', PNG: '598', PRY: '600',
  PER: '604', PHL: '608', POL: '616', PRT: '620', QAT: '634',
  ROU: '642', RUS: '643', RWA: '646', KNA: '659', LCA: '662',
  VCT: '670', WSM: '882', SMR: '674', STP: '678', SAU: '682',
  SEN: '686', SRB: '688', SYC: '690', SLE: '694', SGP: '702',
  SVK: '703', SVN: '705', SLB: '090', SOM: '706', ZAF: '710',
  SSD: '728', ESP: '724', LKA: '144', SDN: '736', SUR: '740',
  SWE: '752', CHE: '756', SYR: '760', TWN: '158', TJK: '762',
  TZA: '834', THA: '764', TLS: '626', TGO: '768', TON: '776',
  TTO: '780', TUN: '788', TUR: '792', TKM: '795', TUV: '798',
  UGA: '800', UKR: '804', ARE: '784', GBR: '826', USA: '840',
  URY: '858', UZB: '860', VUT: '548', VEN: '862', VNM: '704',
  YEM: '887', ZMB: '894', ZWE: '716',
  // Territories and special areas
  HKG: '344', MAC: '446', PSE: '275', XKX: '-99', NCL: '540',
  PYF: '258', GLP: '312', MTQ: '474', REU: '638', GUF: '254',
  FLK: '238', SHN: '654', SPM: '666', WLF: '876', MYT: '175',
  ALA: '248', FRO: '234', GIB: '292', GGY: '831', IMN: '833',
  JEY: '832', PRI: '630', VIR: '850', GUM: '316', MNP: '580',
};

/**
 * Transform raw geographic distribution into map data format.
 * Converts alpha-3 ISO codes to numeric codes for TopoJSON compatibility.
 * @param {Array} data - Raw API response array
 * @returns {Object} Map data object { numericCode: candidateCount }
 */
export function transformToMapData(data) {
  if (!data || data.length === 0) return {};

  return data.reduce((acc, item) => {
    if (item.iso_code) {
      const numericCode = ALPHA3_TO_NUMERIC[item.iso_code] || item.iso_code;
      acc[numericCode] = item.candidateCount;
    }
    return acc;
  }, {});
}

/**
 * Full transformation pipeline for geographic distribution
 * Returns both map format and list format
 * @param {Array} data - Raw API response
 * @returns {{ mapData: Object, distributionList: Array }}
 */
export function transformGeographicDistribution(data) {
  return {
    mapData: transformToMapData(data),
    distributionList: data || [],
  };
}
